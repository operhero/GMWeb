@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.ComponentModel.DataAnnotations

<div class="page">
    <div class="sidebar">
        <NavMenu OnAddTab="HandleAddTab"/>
    </div>

    <main>
        <div class="top-row px-4">
            <AuthorizeView>
                <Authorized>
                    <span>æ¬¢è¿, @context.User.Identity.Name</span>
                    <button class="btn btn-link" @onclick="Logout">æ³¨é”€</button>
                </Authorized>
                <NotAuthorized>
                    <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <!-- æ ‡ç­¾é¡µæ  -->
        <div class="tab-bar">
            <ul class="nav nav-tabs">
                @foreach (var tab in Tabs)
                {
                    <li class="nav-item">
                        <button 
                            class="nav-link @(tab.IsActive ? "active" : "")" 
                            @onclick="() => SwitchTab(tab)"
                            @oncontextmenu:preventDefault>
                            @tab.Title
                            @if (tab.IsClosable)
                            {
                                <span class="tab-close" @onclick:stopPropagation @onclick="() => CloseTab(tab)">
                                    Ã—
                                </span>
                            }
                        </button>
                    </li>
                }
            </ul>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@code {
    [Inject, Required]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; }

    [Inject, Required]
    private NavigationManager NavigationManager { get; set; }

    // æ ‡ç­¾é¡µé›†åˆ
    private List<TabItem> Tabs { get; set; } = new List<TabItem>();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // åˆå§‹åŒ–é»˜è®¤æ ‡ç­¾é¡µï¼ˆä»ªè¡¨ç›˜ï¼‰
        AddTab(new TabItem { Id = "dashboard", Title = "ä»ªè¡¨ç›˜", Url = "/dashboard", IsActive = true, IsClosable = false });
    }

    private void Logout()
    {
        ((CustomAuthenticationStateProvider)AuthenticationStateProvider).Logout();
        NavigationManager.NavigateTo("/login");
    }

    // æ·»åŠ æ ‡ç­¾é¡µ
    public void AddTab(TabItem newTab)
    {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒURLçš„æ ‡ç­¾é¡µ
        var existingTab = Tabs.FirstOrDefault(t => t.Url == newTab.Url);
        if (existingTab != null)
        {
            // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æ¿€æ´»è¯¥æ ‡ç­¾é¡µ
            SwitchTab(existingTab);
            return;
        }

        // æ¿€æ´»æ–°æ ‡ç­¾é¡µå‰ï¼Œå…ˆå°†æ‰€æœ‰å…¶ä»–æ ‡ç­¾é¡µè®¾ç½®ä¸ºéæ¿€æ´»
        Tabs.ForEach(t => t.IsActive = false);
        
        // æ·»åŠ æ–°æ ‡ç­¾é¡µ
        Tabs.Add(newTab);
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    private void SwitchTab(TabItem tab)
    {
        // å°†æ‰€æœ‰æ ‡ç­¾é¡µè®¾ç½®ä¸ºéæ¿€æ´»
        Tabs.ForEach(t => t.IsActive = false);
        
        // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾é¡µ
        tab.IsActive = true;
        
        // å¯¼èˆªåˆ°æ ‡ç­¾é¡µå¯¹åº”çš„URL
        NavigationManager.NavigateTo(tab.Url);
    }

    // å…³é—­æ ‡ç­¾é¡µ
    private void CloseTab(TabItem tab)
    {
        if (!tab.IsClosable) return;

        var tabIndex = Tabs.IndexOf(tab);
        Tabs.Remove(tab);

        // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µï¼Œåˆ™æ¿€æ´»ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ
        if (tab.IsActive && Tabs.Count > 0)
        {
            // å¦‚æœæœ‰ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µï¼Œåˆ™æ¿€æ´»ä¸‹ä¸€ä¸ª
            // å¦åˆ™æ¿€æ´»ä¸Šä¸€ä¸ªæ ‡ç­¾é¡µ
            var newActiveTab = tabIndex < Tabs.Count ? Tabs[tabIndex] : Tabs.Last();
            SwitchTab(newActiveTab);
        }
    }

    // å¤„ç†æ¥è‡ªNavMenuçš„æ·»åŠ æ ‡ç­¾é¡µè¯·æ±‚
    private void HandleAddTab(TabItem tabItem)
    {
        AddTab(tabItem);
    }
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ğŸ—™</span>
</div>