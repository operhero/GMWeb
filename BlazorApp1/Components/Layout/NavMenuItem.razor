@inject NavigationManager NavigationManager
@using System.ComponentModel.DataAnnotations
@using BlazorApp1.Services
@using BlazorApp1.Models

<div class="nav-item px-3">
    @if (Menu.HasChildren)
    {
        <!-- 有子菜单的菜单项 -->
        <div 
            class="nav-link cursor-pointer nav-parent-item"
            @onclick="ToggleSubmenu"
            role="button"
            aria-expanded="@IsExpanded"
            aria-haspopup="true">
            <span class="@Menu.Icon" aria-hidden="true"></span>
            <span class="nav-item-title">@Menu.Title</span>
            <span class="nav-item-arrow float-end">@(IsExpanded ? "▼" : "▶")</span>
        </div>
        
        @if (IsExpanded)
        {
            <div class="nav-submenu pl-4">
                @foreach (var child in Menu.Children)
                {
                    <NavMenuItem 
                        Menu="child" 
                        OnAddTab="OnAddTab" 
                        MenuState="MenuState" />
                }
            </div>
        }
    }
    else
    {
        <!-- 没有子菜单的菜单项 -->
        <div 
            class="nav-link cursor-pointer nav-child-item"
            @onclick="NavigateToMenu"
            role="button">
            <span class="@Menu.Icon" aria-hidden="true"></span>
            <span class="nav-item-title">@Menu.Title</span>
        </div>
    }
</div>

@code {
    // 事件回调：通知父组件添加标签页
    [Parameter]
    public EventCallback<TabItem> OnAddTab { get; set; }

    // 参数：菜单项目
    [Parameter, Required]
    public MenuItem Menu { get; set; }

    // 参数：菜单展开状态
    [Parameter, Required]
    public Dictionary<string, bool> MenuState { get; set; }

    // 当前菜单是否展开
    private bool IsExpanded => MenuState.TryGetValue(Menu.Id, out var expanded) && expanded;

    // 切换子菜单展开状态
    private void ToggleSubmenu()
    {
        MenuState[Menu.Id] = !IsExpanded;
    }

    // 导航到菜单对应的页面
    private async Task NavigateToMenu()
    {
        if (!string.IsNullOrEmpty(Menu.Url))
        {
            await OnAddTab.InvokeAsync(new TabItem 
            {
                Id = Menu.Id, 
                Title = Menu.Title, 
                Url = Menu.Url, 
                IsActive = false, 
                IsClosable = Menu.IsClosable 
            });
        }
    }
}
